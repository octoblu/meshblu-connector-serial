language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "hpXVsJ0Oxwap5P0b4fFNUwO5QWbQpjy9FDJDMWQX7/owqad0wEhp2jO+z/3FAw1ZeStO21GLXDQc/tWHnE/uYR77nERRD9jJcbAhr5XukErvWF3jtLkGosxoBI1oItGNRGe976FwHWBqUYEPyFEMzQPNAvPasw5BfPTEcLGY07m/CvrvXaOT76OR6mVxJDyoX/MuioJjo1SgoI4ThI/caocd4ONBoh+88GyiEO8emLJ4Jb3dOyeEsLhnAfWPToZPhdZnz4Mm+4ybyMK/P++y0KH9P2Sw+T/Pa7kNFYaxmFsrN2p5dL7tYKNhlHs9FrUt03nV7pPQpRXPlaHiAVe56/38GmDFw+yCVMKj5DhUMCZIRfOUYM8fot/yQd48bm2jc828Yd1IewjWyFIweAm234ezxzjRhfIwYHGvOSi3MRQDxxeLNQcMjxeq0bapXTqS9zbNrKyUVNIUbfKNnloePiGIEbeXOzFrDPH3Oww8YZvYBF46BIMxqMp++9hovbS1r0qzbEnHu13C9jsdLdR8WhqkZdfj6gT9JJgWDcdT10ZkT4dKnDMKX8BLhNUxKHxx7lEs/CvIBfiESubyPMGMKvFMHqwuV3ykIrlK0Kx+sX1Di1IgQNm3EXIZv6jRUIiX2lmtLCX+EebicmLUNwg5Oxt0KRNftCB4mQJ1svJmRl0="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "GpNzrsxxPTimv9sIqo3StgXrSghaY69hxVTiokyNlIeEyjnlB0GNOfBbknPipDJ+zq8KkdzfMdzuA1FrPD+DXh+kfrutRYVchisg6QrtAhrBvDyRmaXkKlSjOwJlJmCAxCR9kXnutoAPXpiGjouBQxWj/9TQ2QYqWbeTMxo8vOE+q6zC/xrUZ1z0iIoekngwSMy6gfaHzGcyoArk5DPBZCwCFuiX22TVPDyanU5VoCuwts/UW9PcuahWAQNr1YvxGj05iwp91IvmzMRTe9NGJxdjd3fwdlYV6GyD1kMSK4FnAhMoiaD7Mfduo2Lz1PvMV3WEFW3zNt6S0qwu8DEChSWLk+qouF7RGo/B4wL0AVxHmcGgVtckBcl1/HMi0l1aWdaQQraAGHAwmGlaTIOEdv6d/0lloleavCU8OkagBGEDCY1NdWMtvd+4xM84ecdpRbEACmvLOJ+xJxF1uHwhx6YfXTvzcqoEn+mUoLG+NlCf1x1nzYQVX4bMC/3yYfBOzl/CzSkxdVzg4WfJWLjU+i+3ZgmovvWBvj/PT7apBljuxoNJuPcrZVbDcPVEL7R0EnU06t/83RMBDvkGV96NjpTUbJD0+8NMoCsJ/w/Dyt16RrYjalt756Fm9OOzYaAycbObwn98fVaSGJ4msJ1KRzIXFsNzb67eIbW8Fj+IT88="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
