language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "nM3tAnsE8dKgtzMx2ofvSuC2N8adoY9umHjDR5w9h2Vn2V7QOnRcqNdpcBFLG7qag4WhfU2/ubFnSoEVb36cHBAAjSp+9j+1nVjuXR+CLeCUDLf8SCmy/h+l9CBCn7EHnfVqQD246QRAXMZWCxnevK3K6qaQC66sWmeliAivxrkDXC6lwNxVWj3TOeCxSKzhMpUPo7Pm2j6novpRqT6FIJJtny0/zsbnzfIytmEDYlz5bL51J580EJwbo4AfrAgvrCLZkKHtOgkVmgSOBWa0cxw6liCL/2gGhvHHoHBIEroWM6hQVY4EyXtkvHthNs0bLzNnGHmA4CtLSA5+ecQPHK7YjI44M3xRpuFUVAJ9vDP9poa0bBkep7UFeNXd385VnA4haL7fI3vR5ZSVu0MhOxJeF+9/jI3rYs3BHZkExkvwFRz+/I1Iito3PojCSDwSqWUfFZD94ErvID2NzD6+OuWOVDUR9XVJrHxGZ9ZwiWdyuY3fwYXg2BFp3uZ8B1W2UFkDzs8ghAxCyEBpmQtqYMCQSbcQfTIsJC4hi8Pirw5R90CPQH9L+wWeQy/NRFeMESGVTW58g41kcJfvii/9ywYf+aLPMXhjkQMmbDLKa6F8R6rtCdrR1mtVDhFQ3q3dH5zf3C67TY2zaCDYpkzfWVLcfpplrwhPyVxi0Yd1oZ0="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "PoayemBU8rwwOtTnqnMpacqlq+K8FsCq8o0pN36xm7jT9Eq5P7UXXxEgYkOctxAthYT2ikC8owcMFp8hIfAOxL6pvK6D0t9OVbDOecRtpAmM4D9sFfUyznlOoKdIqnuuTOgSCTRGU03y0F73S5ywPigPWXj0Qaeon+cQv9whHnrhgiFg6FpNILj29nYTFuWou/NwBuNDkzGo6kdCXV0haTnPujvGwH9CDQNDnUv1x7kzvamd9Is38FPI1wVQdUo5XutOrDG7D1MnrMIe81OKIts08RosdYChm2kyg/JhDIqowpiiDQr2VVAKbec/WYIEadx1vpA9cX86sCQG/pbYePZMRwjuYgbTsSseRbihAYq4hKO5Nkx3t0ON8o/21o6NHg9sI1qQyWLa8GAo2v7R6yPIpIfW1mY4l2Usf9Msed4EUB5yK7YL8BrTYrGExmrU5S0XECRo6NIqn0K0djTb7lnywtEixAhrneoPYy2gzZw+uUtmG3OxH+nXOWuP68IY6xHBbp877huVLjRK1osDISybEP/4FLkhTooIXcEN8X/O0OmlHuibB3lOFnLtNdJZ14jZF6vNr9B7qR9efq9kSVLzuu1ltalhtNmmbwXETH26gzKTDYKHkXqbvPjyE6agIfrsesh+Xk9Ssjmo8pExK2234LbzexEL+dRcrVty9q8="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
