language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "lONTK7SuMl7SV0X6F/i/rrC8RfN+daKv8UXQvQ8eY2n8C7txQzahrs1lqGMrf2GWi4m2MyBhF+qfQO8Tg3HtFI3CEB+P6n4WlE5NlIiEI1Txuj1L06mTBSl5ahqs54js314Wn+RUDruw7rOGIDqGc/mb8mIaCnkWK3q7a8BjaYJXf0RLC7JKwI4ml7xJ2wZmh7eMz35s1Cst4jE3u7p0AgUZgrNuiG+IBQM4T+2C+I2Iducf3IzcOwNR0xKy3ks28a+eh34EhkY03xmsLKYq89eBC7AYqXCyZe3pr0idYrBJ/9O7z2JQcF5799EENJhndKAgvgIbqyZ3A5EjWP+zd8Kpql+ABLWUjfVXIGQ8EHZkkEmZ1N3qn+uQeC3TXz5QmigRsP6qjEGaIZVBFVCZOQk5XOb3cmvI14pe26Z3QpqADPGX1I52UB4hxjRfp06iYhqqM+FayIMcC9SRkjGcQfZTRGQvfHgs+y2t/yq6raggFOE/JdRZZ53ImLVi20jrATkTBUxVMIyH7MhkwSuivM2PAc/kxqKtI3FThq+zzyu/RX19I0ExvMFbkMfFIPKmXAEFONQ0XVB1QAMLgw3+EcjrmFuPevSXtmaaDOmQpr+okPR9NTkNCpJpjV4Bjm+Xg74uP6PzPYWeiwXLc93OF/BiYG6NePt3Y4NaI89UGqw="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "HP2j1+hezX9YgFN6DIp4avKmoJ1+R1ljCiVgLYwyUFHu+CkCpxvujeaSLs/F6mOTSOhYwuy+747oxEP9dyJpga1JZMZsXPPC3yqnxWPXmagBUQeylzc9goi8KxFnaf43w1r1iJaAp9mrv9R4HOok5E0GCK6vf0O2OnGRfc4ZmSfeutLz+FOjzbYLkgkcxIc/iCd8UaW0L4xti35fQk5eVYyH3JX2X2ybDDaY8WdV87h6/KRI6sZjEKWiss9riQ5xZdzYdIKhqYCZu/A6oZgy2e/9B7NN4LmTGogjbjm5QLBF0oThZxkbcWF8nvgu/QX09Sr1iDqlQc4bI5leSezHNnlYhiTx+oq/pr6fXLqC8xKSU4Thppsa0H4uwkAdpHABfag0caO7kd34uNB8qCzjqFgMcHqDJvNnckOZj70w5C+MlTA2EjNxe3cMHq+5g5q//gw3kH+o3WyVOMC5IzaGSBRGH92taaaVNEFBMxlQqHUJclZZKntGQmaSC5KElHzlNqPCAN2+cAA9SYXqehf2xqnaTJH01pfcHW20IEqanodI2PSLUmK3MdkqNFD6Iwmu/MRHbUaIUwY0UXUgm/ovWOn4i134KuBFs0SWoj13OVgt5TlzGVeB/1pWsMLlIblb2nUqPociDnp7hm8YNlNGBfABg/97RyU+pCYE4eE1EkI="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
