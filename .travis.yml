language: cpp
os:
- linux
- osx
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
    - g++-4.8-multilib
    - gcc-multilib
    - build-essential
    - libbluetooth-dev
    - libudev-dev
    - libusb-1.0-0-dev
env:
  matrix:
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="amd64" MAIN_BUILD="true"
  - PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
matrix:
  exclude:
  - os: osx
    env: PACKAGER_NODE_VERSION="5.5" PACKAGER_ARCH="386"
branches:
  only:
  - "/^v[0-9]/"
before_install:
- PACKAGER_URL="https://meshblu-connector.octoblu.com/tools/packager/latest"
- curl -fsS "${PACKAGER_URL}/travis_install_node.sh" -o /tmp/travis_install_node.sh
- chmod +x /tmp/travis_install_node.sh
- ". /tmp/travis_install_node.sh"
- if [ "$TRAVIS_OS_NAME" == "linux" -a "$MAIN_BUILD" == "true" ]; then export NPM_PUBLISH="true"; fi
install:
- npm install --build-from-source
script:
- npm test
before_deploy:
- npm install --build-from-source --production
- npm install meshblu-connector-packager
- npm dedupe
- npm install -g flatten-packages
- flatten-packages
- npm run package
deploy:
- provider: releases
  api_key:
    secure: "lOInOqZ/LoWq+WAz5SgXCdHnybYhd+vJa9NXQnWpdy0oWAwnFzBjc2vthdtEmy058mZ4Tm7Icn1gLinA+yTsjamz6aC1C9FnF0UBKDbm5dr5X6odtRrIgULoFMBNFHUlOuVQ2W84omz8tbPieEJ4c+OF9+y07Wu9kRI5WqFBvSyFLeW0lxy0mYGPyO1+IrVVEkJNnhoTXmolMApYaasu6dfFzMuNJsBO/VrhaFc1epPVVUWzy2WpOTwP0unuUao5/YrROtO8nYuX5W25KzgB+K22Tt7TVXoUrIRw9WGNyLw44RtpvrVEpxAaQfT/uQVFx9bNCLuqHBCc79tNhgrZpvn9lWKyqheeNtLMsg7vDtY8Zkwtn07cFQLKn4PQbccseT5FqapiK6qYiLtKBbo+pFVf43S53pWpK8GdOMX8mc0Q3IC0R8x+j7FimwuKjfHjEcPWr5mIYxJ3Gfv8C7a2Dp2TGGkXr2v2gT6sg4nbN6wPuwEMdc57hYncvogTGL8D9zg6NV8KVswt+XBaCIpcxACpkNRglP4o+nQbtAB5BVjy8fRSHZvZpga3piAA94mM/os2R1Ab+UOdZeHyzPR7FQesKXy+8eiFjhwoH4yc1DbUzo1CUz4uFpCmBUxe/tedrhXzLPJvB9x37wUY/yQvF4FwfizWmYNy/mFX8NNIM2U="
  file_glob: true
  file:
  - "deploy/*"
  skip_cleanup: true
  on:
    tags: true
- provider: npm
  email: serveradmin@octoblu.com
  api_key:
    secure: "gwXuRmMrUpIHRTwUu1l8lfWo7MYRKsV8vCKnEI1ZkUhvatztIhehNfn9soT5T++VkZ84VeItfLMrWRtNY/eFs2EoFfXzj9qRHHTWW5IYYGPqnhgcm18QCQ+jPrhPwk1QjUOQ1ev0IfShhPcys+jEHV2C9NL2EHUhtb2Cwwhxrq3TZldRfIZ7UXsOae0Vf4UzfulcFRblyYSe5pJuzNCcUuw4X/wyeg2l0bdqabo1VVc4sy3LE/3/toabOdjPcMLl7AITscjkRYWCc2plsDEbgQxn4uhbW5SJObnC+U/LR1cVOCtqlIm2WBPwzo4RxX+SYLER9PKRedlC3txaqRnb9UBJxy5H4A9tNwc1Fz63y0CefoLZFRNgWVcBYMUnRUfoZItTI2D+D8aFGP99aAQCVcwdOSIVL9gFS6/XnpwB78JuaCDBgyT/2S9/+JQFY7XOELbujFfvuZ+L0Vc67HZ3PfGVRhzIdC5A9Qd0be9e72SUEg+8qsJIpN/696TT2CcxNDJjuRIinbHzsppLxSgXpiS8sRd4BDtwjCfnXLmKENLdzB+zAjgY5jU+h0+OWvSHqpVyhqWY9GUAZ1LTZNRKzMv5DAwtPxfdTpOJToBDPQ/KUtxKtt/L43xhN2b5fdW/4AmZFh7wDsjGQgfwyGq20Xbu2mwpfYwcPzhn4cusZ/Y="
  on:
    tags: true
    condition: "$NPM_PUBLISH = true"
